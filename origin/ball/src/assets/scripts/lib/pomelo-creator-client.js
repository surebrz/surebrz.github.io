!function(){function e(e){if(e)return t(e)}function t(t){for(var n in e.prototype)t[n]=e.prototype[n];return t}e.prototype.on=e.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},e.prototype.once=function(e,t){function n(){r.off(e,n),t.apply(this,arguments)}var r=this;return this._callbacks=this._callbacks||{},n.fn=t,this.on(e,n),this},e.prototype.off=e.prototype.removeListener=e.prototype.removeAllListeners=e.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks[e];if(!n)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r,o=0;o<n.length;o++)if(r=n[o],r===t||r.fn===t){n.splice(o,1);break}return this},e.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n){n=n.slice(0);for(var r=0,o=n.length;r<o;++r)n[r].apply(this,t)}return this},e.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return!!this.listeners(e).length},"undefined"!=typeof window&&(window.EventEmitter=e)}(),function(e,t,n){var r=e,o=4,i=1,c=2,a=1,s=65535,u=1,f=7,l=r.Package={},d=r.Message={};l.TYPE_HANDSHAKE=1,l.TYPE_HANDSHAKE_ACK=2,l.TYPE_HEARTBEAT=3,l.TYPE_DATA=4,l.TYPE_KICK=5,d.TYPE_REQUEST=0,d.TYPE_NOTIFY=1,d.TYPE_RESPONSE=2,d.TYPE_PUSH=3,r.strencode=function(e){for(var n=new t(3*e.length),r=0,o=0;o<e.length;o++){var i=e.charCodeAt(o),c=null;c=i<=127?[i]:i<=2047?[192|i>>6,128|63&i]:[224|i>>12,128|(4032&i)>>6,128|63&i];for(var a=0;a<c.length;a++)n[r]=c[a],++r}var s=new t(r);return p(s,0,n,0,r),s},r.strdecode=function(e){for(var n=new t(e),r=[],o=0,i=0,c=n.length;o<c;)n[o]<128?(i=n[o],o+=1):n[o]<224?(i=((63&n[o])<<6)+(63&n[o+1]),o+=2):(i=((15&n[o])<<12)+((63&n[o+1])<<6)+(63&n[o+2]),o+=3),r.push(i);return String.fromCharCode.apply(null,r)},l.encode=function(e,n){var r=n?n.length:0,i=new t(o+r),c=0;return i[c++]=255&e,i[c++]=r>>16&255,i[c++]=r>>8&255,i[c++]=255&r,n&&p(i,c,n,0,r),i},l.decode=function(e){for(var n=0,r=new t(e),o=0,i=[];n<r.length;){var c=r[n++];o=(r[n++]<<16|r[n++]<<8|r[n++])>>>0;var a=o?new t(o):null;p(a,0,r,n,o),n+=o,i.push({type:c,body:a})}return 1===i.length?i[0]:i},d.encode=function(e,n,o,s,u){var f=h(n)?y(e):0,l=i+f;if(v(n))if(o){if("number"!=typeof s)throw new Error("error flag for number route!");l+=c}else if(l+=a,s){if(s=r.strencode(s),s.length>255)throw new Error("route maxlength is overflow");l+=s.length}u&&(l+=u.length);var d=new t(l),p=0;return p=g(n,o,d,p),h(n)&&(p=w(e,d,p)),v(n)&&(p=b(o,s,d,p)),u&&(p=E(u,d,p)),d},d.decode=function(e){var n=new t(e),o=n.length||n.byteLength,i=0,c=0,a=null,s=n[i++],l=s&u,d=s>>1&f;if(h(d)){var y=parseInt(n[i]),g=0;do{var y=parseInt(n[i]);c+=(127&y)*Math.pow(2,7*g),i++,g++}while(y>=128)}if(v(d))if(l)a=n[i++]<<8|n[i++];else{var w=n[i++];w?(a=new t(w),p(a,0,n,i,w),a=r.strdecode(a)):a="",i+=w}var b=o-i,E=new t(b);return p(E,0,n,i,b),{id:c,type:d,compressRoute:l,route:a,body:E}};var p=function(e,t,n,r,o){if("function"==typeof n.copy)n.copy(e,t,r,r+o);else for(var i=0;i<o;i++)e[t++]=n[r++]},h=function(e){return e===d.TYPE_REQUEST||e===d.TYPE_RESPONSE},v=function(e){return e===d.TYPE_REQUEST||e===d.TYPE_NOTIFY||e===d.TYPE_PUSH},y=function(e){var t=0;do t+=1,e>>=7;while(e>0);return t},g=function(e,t,n,r){if(e!==d.TYPE_REQUEST&&e!==d.TYPE_NOTIFY&&e!==d.TYPE_RESPONSE&&e!==d.TYPE_PUSH)throw new Error("unkonw message type: "+e);return n[r]=e<<1|(t?1:0),r+i},w=function(e,t,n){do{var r=e%128,o=Math.floor(e/128);0!==o&&(r+=128),t[n++]=r,e=o}while(0!==e);return n},b=function(e,t,n,r){if(e){if(t>s)throw new Error("route number is overflow");n[r++]=t>>8&255,n[r++]=255&t}else t?(n[r++]=255&t.length,p(n,r,t,0,t.length),r+=t.length):n[r++]=0;return r},E=function(e,t,n){return p(t,n,e,0,e.length),n+e.length};"undefined"!=typeof window&&(window.Protocol=r)}("undefined"==typeof window?module.exports:{},"undefined"==typeof window?Buffer:Uint8Array,this),function(e,t){var n=e;n.init=function(e){n.encoder.init(e.encoderProtos),n.decoder.init(e.decoderProtos)},n.encode=function(e,t){return n.encoder.encode(e,t)},n.decode=function(e,t){return n.decoder.decode(e,t)},"undefined"!=typeof window&&(window.protobuf=n)}("undefined"==typeof window?module.exports:{},this),function(e,t){var n=e.constants={};n.TYPES={uInt32:0,sInt32:0,int32:0,"double":1,string:2,message:2,"float":5}}("undefined"!=typeof protobuf?protobuf:module.exports,this),function(e,t){var n=e.util={};n.isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e}}("undefined"!=typeof protobuf?protobuf:module.exports,this),function(e,t){function n(e){return e<=127?[e]:e<=2047?[192|e>>6,128|63&e]:[224|e>>12,128|(4032&e)>>6,128|63&e]}function r(e){return e<=127?1:e<=2047?2:3}var o=e.codec={},i=new ArrayBuffer(8),c=new Float32Array(i),a=new Float64Array(i),s=new Uint8Array(i);o.encodeUInt32=function(e){var e=parseInt(e);if(isNaN(e)||e<0)return null;var t=[];do{var n=e%128,r=Math.floor(e/128);0!==r&&(n+=128),t.push(n),e=r}while(0!==e);return t},o.encodeSInt32=function(e){var e=parseInt(e);return isNaN(e)?null:(e=e<0?2*Math.abs(e)-1:2*e,o.encodeUInt32(e))},o.decodeUInt32=function(e){for(var t=0,n=0;n<e.length;n++){var r=parseInt(e[n]);if(t+=(127&r)*Math.pow(2,7*n),r<128)return t}return t},o.decodeSInt32=function(e){var t=this.decodeUInt32(e),n=t%2===1?-1:1;return t=(t%2+t)/2*n},o.encodeFloat=function(e){return c[0]=e,s},o.decodeFloat=function(e,t){if(!e||e.length<t+4)return null;for(var n=0;n<4;n++)s[n]=e[t+n];return c[0]},o.encodeDouble=function(e){return a[0]=e,s.subarray(0,8)},o.decodeDouble=function(e,t){if(!e||e.length<t+8)return null;for(var n=0;n<8;n++)s[n]=e[t+n];return a[0]},o.encodeStr=function(e,t,r){for(var o=0;o<r.length;o++)for(var i=r.charCodeAt(o),c=n(i),a=0;a<c.length;a++)e[t]=c[a],t++;return t},o.decodeStr=function(e,t,n){for(var r=[],o=t+n;t<o;){var i=0;e[t]<128?(i=e[t],t+=1):e[t]<224?(i=((63&e[t])<<6)+(63&e[t+1]),t+=2):(i=((15&e[t])<<12)+((63&e[t+1])<<6)+(63&e[t+2]),t+=3),r.push(i)}for(var c="",a=0;a<r.length;)c+=String.fromCharCode.apply(null,r.slice(a,a+1e4)),a+=1e4;return c},o.byteLength=function(e){if("string"!=typeof e)return-1;for(var t=0,n=0;n<e.length;n++){var o=e.charCodeAt(n);t+=r(o)}return t}}("undefined"!=typeof protobuf?protobuf:module.exports,this),function(e,t){function n(e,t){if(!t)return!1;for(var r in t){var o=t[r];switch(o.option){case"required":if("undefined"==typeof e[r])return console.warn("no property exist for required! name: %j, proto: %j, msg: %j",r,o,e),!1;case"optional":if("undefined"!=typeof e[r]){var i=t.__messages[o.type]||u.protos["message "+o.type];if(i&&!n(e[r],i))return console.warn("inner proto error! name: %j, proto: %j, msg: %j",r,o,e),!1}break;case"repeated":var i=t.__messages[o.type]||u.protos["message "+o.type];if(e[r]&&i)for(var c=0;c<e[r].length;c++)if(!n(e[r][c],i))return!1}}return!0}function r(e,t,n,r){for(var s in r)if(n[s]){var u=n[s];switch(u.option){case"required":case"optional":t=c(e,t,a(u.type,u.tag)),t=o(r[s],u.type,t,e,n);break;case"repeated":r[s].length>0&&(t=i(r[s],u,t,e,n))}}return t}function o(e,t,n,o,i){switch(t){case"uInt32":n=c(o,n,f.encodeUInt32(e));break;case"int32":case"sInt32":n=c(o,n,f.encodeSInt32(e));break;case"float":c(o,n,f.encodeFloat(e)),n+=4;break;case"double":c(o,n,f.encodeDouble(e)),n+=8;break;case"string":var a=f.byteLength(e);n=c(o,n,f.encodeUInt32(a)),f.encodeStr(o,n,e),n+=a;break;default:var s=i.__messages[t]||u.protos["message "+t];if(s){var l=new ArrayBuffer(2*f.byteLength(JSON.stringify(e))),a=0;a=r(l,a,s,e),n=c(o,n,f.encodeUInt32(a));for(var d=0;d<a;d++)o[n]=l[d],n++}}return n}function i(e,t,n,r,i){var s=0;if(d.isSimpleType(t.type))for(n=c(r,n,a(t.type,t.tag)),n=c(r,n,f.encodeUInt32(e.length)),s=0;s<e.length;s++)n=o(e[s],t.type,n,r);else for(s=0;s<e.length;s++)n=c(r,n,a(t.type,t.tag)),n=o(e[s],t.type,n,r,i);return n}function c(e,t,n){for(var r=0;r<n.length;r++,t++)e[t]=n[r];return t}function a(e,t){var n=l.TYPES[e]||2;return f.encodeUInt32(t<<3|n)}var s=e,u=e.encoder={},f=s.codec,l=s.constants,d=s.util;u.init=function(e){this.protos=e||{}},u.encode=function(e,t){var o=this.protos[e];if(!n(t,o))return null;var i=f.byteLength(JSON.stringify(t)),c=new ArrayBuffer(i),a=new Uint8Array(c),s=0;return o&&(s=r(a,s,o,t),s>0)?a.subarray(0,s):null}}("undefined"!=typeof protobuf?protobuf:module.exports,this),function(e,t){function n(e,t,n){for(;d<n;){var c=r(),a=(c.type,c.tag),s=t.__tags[a];switch(t[s].option){case"optional":case"required":e[s]=o(t[s].type,t);break;case"repeated":e[s]||(e[s]=[]),i(e[s],t[s].type,t)}}return e}function r(){var e=f.decodeUInt32(c());return{type:7&e,tag:e>>3}}function o(e,t){switch(e){case"uInt32":return f.decodeUInt32(c());case"int32":case"sInt32":return f.decodeSInt32(c());case"float":var r=f.decodeFloat(a,d);return d+=4,r;case"double":var o=f.decodeDouble(a,d);return d+=8,o;case"string":var i=f.decodeUInt32(c()),s=f.decodeStr(a,d,i);return d+=i,s;default:var l=t&&(t.__messages[e]||u.protos["message "+e]);if(l){var i=f.decodeUInt32(c()),p={};return n(p,l,d+i),p}}}function i(e,t,n){if(l.isSimpleType(t))for(var r=f.decodeUInt32(c()),i=0;i<r;i++)e.push(o(t));else e.push(o(t,n))}function c(e){var t=[],n=d;e=e||!1;var r;do r=a[n],t.push(r),n++;while(r>=128);return e||(d=n),t}var a,s=e,u=e.decoder={},f=s.codec,l=s.util,d=0;u.init=function(e){this.protos=e||{}},u.setProtos=function(e){e&&(this.protos=e)},u.decode=function(e,t){var r=this.protos[e];return a=t,d=0,r?n({},r,a.length):null}}("undefined"!=typeof protobuf?protobuf:module.exports,this),function(){var e="js-websocket",t="0.0.1",n=window.Protocol,r=window.protobuf,o=window.decodeIO_protobuf,i=null,c=null,a=n.Package,s=n.Message,u=window.EventEmitter,f=window.rsa;"undefined"!=typeof window&&"undefined"!=typeof sys&&sys.localStorage&&(window.localStorage=sys.localStorage);var l=200,d=501;"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var p=window,h=Object.create(u.prototype);p.pomelo=h;var v,y=null,g=0,w={},b={},E={},m={},_={},T={},S={},P=0,I=0,k=0,A=0,Y=100,N=null,U=null,O=null,H=null,D=null,J=!1,R=null,C=null,K=0,j=5e3,x=10,F={sys:{type:e,version:t,rsa:{}},user:{}},L=null;h.init=function(e,t){L=t;var n=e.host,r=e.port;D=e.encode||M,H=e.decode||B;var o="ws://"+n;if(r&&(o+=":"+r),F.user=e.user,e.encrypt){v=!0,f.generate(1024,"10001");var i={rsa_n:f.n.toString(16),rsa_e:f.e};F.sys.rsa=i}O=e.handshakeCallback,q(e,o,t)};var B=h.decode=function(e){var t=s.decode(e);if(!(t.id>0)||(t.route=E[t.id],delete E[t.id],t.route))return t.body=ne(t),t},M=h.encode=function(e,t,o){var c=e?s.TYPE_REQUEST:s.TYPE_NOTIFY;if(r&&S[t])o=r.encode(t,o);else if(i&&i.lookup(t)){var a=i.build(t);o=new a(o).encodeNB()}else o=n.strencode(JSON.stringify(o));var u=0;return m&&m[t]&&(t=m[t],u=1),s.encode(e,c,u,t,o)},q=function(e,t,s){console.log("connect to "+t);var e=e||{},u=e.maxReconnectAttempts||x;if(C=t,window.localStorage&&window.localStorage.getItem("protos")&&0===P){var f=JSON.parse(window.localStorage.getItem("protos"));P=f.version||0,T=f.server||{},S=f.client||{},r&&r.init({encoderProtos:S,decoderProtos:T}),o&&(i=o.loadJson(S),c=o.loadJson(T))}F.sys.protoVersion=P;var l=function(e){J&&h.emit("reconnect"),Q();var t=a.encode(a.TYPE_HANDSHAKE,n.strencode(JSON.stringify(F)));W(t)},d=function(e){ee(a.decode(e.data),s),k&&(A=Date.now()+k)},p=function(e){h.emit("io-error",e),console.error("socket error: ",e)},v=function(t){h.emit("close",t),h.emit("disconnect",t),console.error("socket close: ",t),e.reconnect&&K<u&&(J=!0,K++,R=setTimeout(function(){q(e,C,s)},j),j*=2)};y=new WebSocket(t),y.binaryType="arraybuffer",y.onopen=l,y.onmessage=d,y.onerror=p,y.onclose=v};h.disconnect=function(){y&&(y.disconnect&&y.disconnect(),y.close&&y.close(),console.log("disconnect"),y=null),N&&(clearTimeout(N),N=null),U&&(clearTimeout(U),U=null)};var Q=function(){J=!1,j=5e3,K=0,clearTimeout(R)};h.request=function(e,t,n){2===arguments.length&&"function"==typeof t?(n=t,t={}):t=t||{},e=e||t.route,e&&(g++,V(g,e,t),w[g]=n,E[g]=e)},h.notify=function(e,t){t=t||{},V(0,e,t)};var V=function(e,t,n){if(v){n=JSON.stringify(n);var r=f.signString(n,"sha256");n=JSON.parse(n),n.__crypto__=r}D&&(n=D(e,t,n));var o=a.encode(a.TYPE_DATA,n);W(o)},W=function(e){y.send(e.buffer)},z=function(e){if(I){var t=a.encode(a.TYPE_HEARTBEAT);U&&(clearTimeout(U),U=null),N||(N=setTimeout(function(){N=null,W(t),A=Date.now()+k,U=setTimeout(G,k)},I))}},G=function(){var e=A-Date.now();e>Y?U=setTimeout(G,e):(console.error("server heartbeat timeout"),h.emit("heartbeat timeout"),h.disconnect())},X=function(e){if(e=JSON.parse(n.strdecode(e)),e.code===d)return void h.emit("error","client version not fullfill");if(e.code!==l)return void h.emit("error","handshake fail");re(e);var t=a.encode(a.TYPE_HANDSHAKE_ACK);W(t),L&&L(y)},Z=function(e){var t=e;H&&(t=H(t)),te(h,t)},$=function(e){e=JSON.parse(n.strdecode(e)),h.emit("onKick",e)};b[a.TYPE_HANDSHAKE]=X,b[a.TYPE_HEARTBEAT]=z,b[a.TYPE_DATA]=Z,b[a.TYPE_KICK]=$;var ee=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];b[n.type](n.body)}else b[e.type](e.body)},te=function(e,t){if(!t.id)return void e.emit(t.route,t.body);var n=w[t.id];delete w[t.id],"function"==typeof n&&n(t.body)},ne=function(e){var t=e.route;if(e.compressRoute){if(!_[t])return{};t=e.route=_[t]}return r&&T[t]?r.decode(t,e.body):c&&c.lookup(t)?c.build(t).decode(e.body):JSON.parse(n.strdecode(e.body))},re=function(e){e.sys&&e.sys.heartbeat?(I=1e3*e.sys.heartbeat,k=2*I):(I=0,k=0),oe(e),"function"==typeof O&&O(e.user)},oe=function(e){if(e&&e.sys){m=e.sys.dict;var t=e.sys.protos;if(m){m=m,_={};for(var n in m)_[m[n]]=n}t&&(P=t.version||0,T=t.server||{},S=t.client||{},window.localStorage.setItem("protos",JSON.stringify(t)),r&&r.init({encoderProtos:t.client,decoderProtos:t.server}),o&&(i=o.loadJson(S),c=o.loadJson(T)))}}}();